ğŸŒŒ Nebula KTV - æŠ€æœ¯æ¶æ„è®¾è®¡è¯´æ˜ä¹¦
| é¡¹ç›®ä¿¡æ¯ | å†…å®¹ |
|---|---|
| é˜¶æ®µ | Phase 4: Technical Architecture Design |
| ç‰ˆæœ¬ | v1.0 (AI-Native Edition) |
| æ ¸å¿ƒç†å¿µ | AI-First Architecture, MVP-First Implementation |
| éƒ¨ç½²ç¯å¢ƒ | Home NAS (Docker) + Zeekr 8155 (Web Client) |
1. æ¶æ„æ€»è§ˆ (Architecture Overview)
æœ¬ç³»ç»Ÿé‡‡ç”¨ å¾®æœåŠ¡åŒ– (Microservices-like) çš„å®¹å™¨æ¶æ„ã€‚æ ¸å¿ƒè®¾è®¡ç­–ç•¥ä¸º â€œé¢„åŸ‹ç®¡çº¿ (Pre-plumbing)â€ï¼š
 * æ•°æ®å±‚ï¼š ä½¿ç”¨ PostgreSQL + pgvectorï¼Œä»åº•å±‚ç»Ÿä¸€ç®¡ç†ç»“æ„åŒ–æ•°æ®ï¼ˆSQLï¼‰ã€åŠç»“æ„åŒ–æ•°æ®ï¼ˆJSONï¼‰å’Œ AI ç‰¹å¾æ•°æ®ï¼ˆVectorï¼‰ã€‚
 * é€»è¾‘å±‚ï¼š é‡‡ç”¨ LangGraph (å›¾ç¼–æ’) æ€æƒ³ã€‚å³ä½¿æ˜¯ç®€å•çš„â€œä¸‹è½½-å…¥åº“â€æµç¨‹ï¼Œä¹Ÿè¢«å®šä¹‰ä¸ºå›¾ä¸­çš„èŠ‚ç‚¹ (Node)ã€‚MVP é˜¶æ®µèŠ‚ç‚¹è¿è¡Œä¼ ç»Ÿä»£ç ï¼Œæœªæ¥èŠ‚ç‚¹æ— ç¼æ›¿æ¢ä¸º LLM Agentã€‚
 * äº¤äº’å±‚ï¼š å‰ç«¯é€šè¿‡ Vercel AI SDK é€šä¿¡ï¼Œåç«¯é€šè¿‡ MCP (Model Context Protocol) æš´éœ²èƒ½åŠ›ï¼Œç¡®ä¿ç³»ç»Ÿæ—¢èƒ½è¢«äººç±»æ“ä½œï¼Œä¹Ÿèƒ½è¢« AI åŠ©æ‰‹è°ƒç”¨ã€‚
2. ç³»ç»Ÿæ‹“æ‰‘å›¾ (System Topology)
graph TD
    User((User/Driver)) -->|Web Browser| Frontend[Next.js App]
    ExtAI((Claude/Cursor)) -->|MCP Protocol| Backend
    
    subgraph NAS_Docker_Host
        Frontend -->|Server Actions| Backend[FastAPI Server]
        
        Backend -->|R/W| DB[(PostgreSQL + pgvector)]
        Backend -->|Job| Broker[Redis]
        
        Broker -->|Consume| Worker[Celery/LangGraph Worker]
        
        Worker -->|Read/Write| Storage[NAS File System]
        Worker -->|Inference| Models[UVR5 / Whisper / LocalLLM]
    end
    
    DB -->|Vector Search| Backend

3. æŠ€æœ¯é€‰å‹ (The Nebula Stack)
3.1 å‰ç«¯ (The Surface)
 * æ¡†æ¶: Next.js 14 (App Router)
   * ç†ç”±: åˆ©ç”¨ RSC (React Server Components) å°†è®¡ç®—å‹åŠ›ç•™åœ¨ NAS æœåŠ¡ç«¯ï¼Œå‡è½»è½¦è½½æµè§ˆå™¨è´Ÿæ‹…ã€‚
 * UI åº“: Tailwind CSS + shadcn/ui
   * ç†ç”±: é›¶è®¾è®¡èƒŒæ™¯ä¹Ÿèƒ½äº§å‡ºé«˜è´¨é‡â€œæš—å¤œç»ç’ƒè´¨æ„Ÿâ€ç•Œé¢ï¼Œå¼€å‘æå¿«ã€‚
 * äº¤äº’ SDK: Vercel AI SDK (Core)
   * ç†ç”±: ç»Ÿä¸€å¤„ç†æµå¼å“åº” (Streaming)ï¼Œä¸ºæœªæ¥ AI ç”Ÿæˆç•Œé¢é¢„ç•™é€šé“ã€‚
3.2 åç«¯ (The Brain)
 * æ¡†æ¶: FastAPI (Python 3.11+)
   * ç†ç”±: åŸç”Ÿå¼‚æ­¥ (AsyncIO) å¤„ç†æµåª’ä½“é«˜å¹¶å‘ï¼›å®Œç¾æ”¯æŒ AI/Python ç”Ÿæ€ã€‚
 * ç¼–æ’: LangGraph (é€»è¾‘å±‚)
   * ç†ç”±: å°†ä¸šåŠ¡é€»è¾‘ç»“æ„åŒ–ä¸ºâ€œçŠ¶æ€æœºâ€ï¼Œæ–¹ä¾¿ AI ä»‹å…¥å†³ç­–ã€‚
 * åè®®: MCP Python SDK
   * ç†ç”±: å®ç°ç³»ç»Ÿå¯¹å¤–å¯æ‰©å±•æ€§ï¼Œæ”¯æŒ cursor/Claude ç›´è¿æ•°æ®åº“ã€‚
3.3 æ•°æ®ä¸å­˜å‚¨ (The Memory)
 * æ•°æ®åº“: PostgreSQL 16
   * æ’ä»¶: pgvector (å‘é‡æ£€ç´¢)
   * ç†ç”±: ä¸€ä½“åŒ–å­˜å‚¨ã€‚æ— éœ€é¢å¤–éƒ¨ç½² Redis ç¼“å­˜æˆ– ChromaDB å‘é‡åº“ã€‚
 * ORM: Prisma (Python Client æˆ– Node Client)
   * ç†ç”±: ç±»å‹å®‰å…¨ï¼ŒSchema å®šä¹‰æ¸…æ™°ã€‚
3.4 ä»»åŠ¡ä¸ AI (The Muscle)
 * é˜Ÿåˆ—: Celery + Redis
 * æ¨¡å‹:
   * Audio Separation: audio-separator (UVR5 å°è£…)
   * ASR: faster-whisper (CTranslate2 åŠ é€Ÿç‰ˆ)
   * Local LLM: Ollama (å¯é€‰ï¼Œè¿è¡Œ Llama3/Mistral)
4. æ•°æ®åº“è®¾è®¡ (Schema Design)
æ–‡ä»¶ï¼šschema.sql (åˆå§‹åŒ–è„šæœ¬)
æ ¸å¿ƒåœ¨äº feature_vector å’Œ meta_json çš„é¢„ç•™ã€‚
-- å¯ç”¨ AI å‘é‡æ‰©å±•
CREATE EXTENSION IF NOT EXISTS vector;

-- ğŸµ æ­Œæ›²ä¸»è¡¨ï¼šèåˆ SQL + NoSQL + AI
CREATE TABLE songs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- [åŸºç¡€å…ƒæ•°æ®]
    title TEXT NOT NULL,
    artist TEXT NOT NULL,
    status VARCHAR(20) DEFAULT 'PENDING', -- PENDING, PROCESSING, READY, PARTIAL, FAILED
    
    -- [ä¸šåŠ¡ç´¢å¼•å­—æ®µ]
    title_abbr VARCHAR(50),  -- æ‹¼éŸ³é¦–å­—æ¯ 'qlx'
    artist_abbr VARCHAR(50), -- æ‹¼éŸ³é¦–å­—æ¯ 'zjl'
    region VARCHAR(20),      -- 'Mandarin', 'Western'
    
    -- [æ‰©å±•æ•°æ® - JSONB]
    -- å­˜å‚¨ BPM, Key, Tags, æ­Œè¯ç‰ˆæƒ, æ¥æºURLç­‰æ‰€æœ‰æœªæ¥å­—æ®µ
    meta_json JSONB DEFAULT '{}',

    -- [AI å¤§è„‘ - Vector]
    -- 768ç»´å‘é‡ï¼Œç”¨äº"è¯­ä¹‰æœæ­Œ" (ä¾‹å¦‚: æœ"é€‚åˆå¤±æ‹å¬çš„æ­Œ")
    feature_vector vector(768),

    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ğŸ“€ åª’ä½“èµ„äº§è¡¨ï¼šæ”¯æŒ Source Crossfade
CREATE TABLE media_assets (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    song_id UUID REFERENCES songs(id) ON DELETE CASCADE,
    
    -- å…³é”®å­—æ®µï¼šåŒºåˆ†åŸå”±å’Œä¼´å¥
    type VARCHAR(30) NOT NULL, -- 'video_main', 'audio_original', 'audio_inst', 'lyrics_json'
    path TEXT NOT NULL,        -- ç›¸å¯¹è·¯å¾„
    
    file_meta JSONB DEFAULT '{}' -- å­˜ bitrate, codec, size
);

-- å»ºç«‹ AI ä¸“ç”¨ç´¢å¼• (HNSW) - æå¤§æå‡æ£€ç´¢é€Ÿåº¦
CREATE INDEX ON songs USING hnsw (feature_vector vector_cosine_ops);
-- å»ºç«‹ JSON ç´¢å¼•
CREATE INDEX idx_songs_meta ON songs USING GIN (meta_json);

5. åŸºç¡€è®¾æ–½ç¼–æ’ (Infrastructure)
æ–‡ä»¶ï¼šdocker-compose.yml
è¿™æ˜¯ä½ åœ¨ NAS ä¸Šå¯åŠ¨é¡¹ç›®çš„å”¯ä¸€å…¥å£ã€‚
version: '3.8'

services:
  # 1. æ•°æ®åº“ (The Brain's Storage)
  db:
    image: pgvector/pgvector:pg16
    container_name: nebula_db
    restart: always
    environment:
      POSTGRES_USER: nebula
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: nebula_ktv
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  # 2. æ¶ˆæ¯ä¸­é—´ä»¶ (The Nervous System)
  redis:
    image: redis:alpine
    container_name: nebula_redis
    restart: always

  # 3. åç«¯ API (The Controller)
  api:
    build: ./backend
    container_name: nebula_api
    restart: always
    depends_on:
      - db
      - redis
    volumes:
      - ./backend:/app
      - ./data/media:/data/media  # æ˜ å°„ NAS åª’ä½“ç›®å½•
    environment:
      DATABASE_URL: postgresql://nebula:${DB_PASSWORD}@db:5432/nebula_ktv
      CELERY_BROKER_URL: redis://redis:6379/0

  # 4. AI Worker (The Muscle)
  worker:
    build: ./backend
    container_name: nebula_worker
    command: celery -A worker.celery_app worker --loglevel=info
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia  # å¦‚æœ NAS æœ‰æ˜¾å¡æ”¯æŒ
              count: 1
              capabilities: [gpu]
    volumes:
      - ./backend:/app
      - ./data/media:/data/media
    depends_on:
      - redis
      - db

  # 5. å‰ç«¯ Web (The Face)
  web:
    build: ./frontend
    container_name: nebula_web
    restart: always
    ports:
      - "3000:3000"
    depends_on:
      - api

6. æ¥å£è®¾è®¡ç­–ç•¥ (Interface Strategy)
æˆ‘ä»¬é‡‡ç”¨ "åŒé€šé“ (Dual-Channel)" æ¥å£è®¾è®¡ã€‚
é€šé“ A: ä¼ ç»Ÿçš„ REST API (ç”¨äºå‰ç«¯ UI)
 * GET /api/songs - è·å–åˆ—è¡¨ (æ”¯æŒåˆ†é¡µ, JSONB ç­›é€‰)
 * GET /api/stream/{asset_id} - è§†é¢‘/éŸ³é¢‘æµ (æ”¯æŒ Range Requests)
 * POST /api/control/action - æ’­æ”¾æ§åˆ¶
é€šé“ B: MCP åè®®æ¥å£ (ç”¨äº AI Agent)
 * Tool: search_library(query: str) - è¯­ä¹‰æœç´¢
 * Tool: add_song(url: str) - è§¦å‘ä¸‹è½½ä»»åŠ¡
 * Resource: db://songs/stats - è·å–åº“ç»Ÿè®¡ä¿¡æ¯
 * Prompt: recommend_playlist - è®© AI æ¨èæ­Œå•
7. å¼€å‘å®æ–½è·¯çº¿å›¾ (Implementation Roadmap)
 * Stage 4.1: Skeleton (éª¨æ¶)
   * åˆ›å»º docker-compose.ymlã€‚
   * å¯åŠ¨ Postgres å’Œ Redisã€‚
   * éªŒè¯æ•°æ®åº“è¿æ¥ã€‚
 * Stage 4.2: Backend Core (æ ¸å¿ƒ)
   * ç”¨ FastAPI å†™å‡º Hello Worldã€‚
   * å®ç° Songs è¡¨çš„ CRUDã€‚
   * å…³é”®ï¼š ç¼–å†™â€œç©º AI Workerâ€ï¼Œå³è¾“å…¥æ–‡ä»¶ï¼Œä¸åšå¤„ç†ï¼Œç›´æ¥åœ¨æ•°æ®åº“æ ‡è®°ä¸º READYï¼ˆç”¨äºè·‘é€šæµç¨‹ï¼‰ã€‚
 * Stage 4.3: Frontend UI (ç•Œé¢)
   * åˆå§‹åŒ– Next.js + Tailwindã€‚
   * å®‰è£… shadcn/ui ç»„ä»¶ã€‚
   * å®ç°é¦–é¡µåˆ—è¡¨å’Œæ’­æ”¾å™¨ UIã€‚
 * Stage 4.4: AI Injection (æ³¨å…¥ AI)
   * å°† Worker é‡Œçš„â€œç©ºé€»è¾‘â€æ›¿æ¢ä¸º audio-separator å’Œ whisper ä»£ç ã€‚
   * å¼€å¯ Postgres çš„ Vector æ’ä»¶ã€‚
