Nebula KTV 终极元数据架构 (Schema v4.0 - Maximum Detail Edition)。
这一版设计引入了 “创作者维度”（词曲作者）、“演唱维度”（合唱/对唱类型）以及 “AI 分析维度”（声纹特征）。
🏛️ Nebula KTV Database Schema (PostgreSQL 16)
1. 核心歌曲表 (songs)
这是你的核心资产库，每一个字段都对应着未来的一种“搜歌方式”。
CREATE EXTENSION IF NOT EXISTS vector; -- 启用 AI 向量支持

CREATE TABLE songs (
    -- ==========================================
    -- 1. 基础身份信息 (Basic Identity)
    -- ==========================================
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title TEXT NOT NULL,                -- 歌名 (e.g., "七里香")
    subtitle TEXT,                      -- 副标题/备注 (e.g., "Live at 无与伦比演唱会")
    artist TEXT NOT NULL,               -- 歌手 (e.g., "周杰伦")
    album TEXT,                         -- 专辑 (e.g., "七里香")
    year INTEGER,                       -- 发行年份 (e.g., 2004)
    cover_path TEXT,                    -- 封面相对路径
    
    -- ==========================================
    -- 2. 创作与版权信息 (Credits & Copyright) - KTV 高级搜索用
    -- ==========================================
    lyricist TEXT,                      -- 作词 (e.g., "方文山") -> 搜“方文山写的歌”
    composer TEXT,                      -- 作曲 (e.g., "周杰伦") -> 搜“周杰伦写的歌”
    arranger TEXT,                      -- 编曲 (e.g., "钟兴民")
    publisher TEXT,                     -- 发行公司 (e.g., "杰威尔音乐")
    
    -- ==========================================
    -- 3. KTV 业务分类 (KTV Classification)
    -- ==========================================
    -- 语言与地区
    language_family VARCHAR(20),        -- 语系: 'Chinese', 'English', 'Japanese', 'Korean'
    language_dialect VARCHAR(20),       -- 方言: 'Mandarin'(国语), 'Cantonese'(粤语), 'Hokkien'(闽南语)
    
    -- 演唱形式 (决定是否适合多人互动)
    singing_type VARCHAR(20),           -- 'Solo'(独唱), 'Duet'(对唱), 'Group'(组合), 'Choir'(大合唱)
    gender_type VARCHAR(20),            -- 'Male', 'Female', 'Mix'(男女对唱), 'Band'
    
    -- 风格与场景
    genre VARCHAR(30),                  -- 流派: 'Pop', 'Rock', 'R&B', 'Ballad'(抒情), 'EDM'
    scenario JSONB,                     -- 场景标签 (Array): "['Wedding', 'Driving', 'Breakup']"
    
    -- ==========================================
    -- 4. 搜索优化 (Search Index) - 拼音/缩写
    -- ==========================================
    title_pinyin TEXT,                  -- 'qi li xiang'
    title_abbr VARCHAR(50),             -- 'qlx'
    artist_pinyin TEXT,                 -- 'zhou jie lun'
    artist_abbr VARCHAR(50),            -- 'zjl'
    aliases JSONB,                      -- 别名: "['Common Jasmine Orange', '7里香']"
    
    -- ==========================================
    -- 5. AI 音频指纹 (AI Audio Analysis) - 智能推荐的核心
    -- ==========================================
    duration INTEGER,                   -- 时长 (秒)
    bpm INTEGER,                        -- 速度 (BPM)
    original_key VARCHAR(10),           -- 原调 (e.g., 'C#m')
    camelot_key VARCHAR(5),             -- 混音调式 (e.g., '12B') - 用于“无缝接歌”推荐
    
    -- 能量值 (Spotify 风格指标，0.0 - 1.0)
    energy NUMERIC(3,2),                -- 能量感 (0.1=助眠, 0.9=夜店)
    danceability NUMERIC(3,2),          -- 舞曲感
    valence NUMERIC(3,2),               -- 正能量指数 (0.1=悲伤, 0.9=快乐)
    
    -- 演唱难度 (AI 分析音高得出)
    vocal_range_low VARCHAR(5),         -- 最低音 (e.g., 'G3')
    vocal_range_high VARCHAR(5),        -- 最高音 (e.g., 'A5')
    difficulty_level INTEGER,           -- 综合难度 (1-5 星)

    -- AI 语义向量 (用于自然语言搜歌)
    feature_vector vector(768),         

    -- ==========================================
    -- 6. 状态与运营 (Operations)
    -- ==========================================
    status VARCHAR(20) DEFAULT 'PENDING',
    play_count INTEGER DEFAULT 0,
    last_played_at TIMESTAMPTZ,
    is_favorite BOOLEAN DEFAULT FALSE,
    quality_badge VARCHAR(10),          -- '4K', 'HD', 'SD' (根据视频分辨率自动打标)

    -- 兜底字段 (存储 API 抓来的其他乱七八糟数据)
    meta_json JSONB DEFAULT '{}',       

    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 建立强力索引
CREATE INDEX idx_search_full ON songs(title_abbr, artist_abbr);
CREATE INDEX idx_credits ON songs(lyricist, composer); -- 支持搜作词人
CREATE INDEX idx_audio_match ON songs(bpm, energy);    -- 支持搜“差不多感觉的歌”
CREATE INDEX idx_vocal_match ON songs USING GIN (scenario); -- 支持搜场景

2. 媒体资产表 (media_assets)
为了支持极高清画质和无损音质，这里也要细化。
CREATE TABLE media_assets (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    song_id UUID REFERENCES songs(id) ON DELETE CASCADE,
    
    -- 资产类型细分
    type VARCHAR(30) NOT NULL, 
    -- 'video_master': 主视频文件
    -- 'audio_original': 原版立体声 (无损/高码率)
    -- 'audio_inst': AI 分离的伴奏
    -- 'audio_vocal': AI 分离的人声 (用于评分/练习)
    -- 'lyrics_vtt': 时间轴歌词
    -- 'lyrics_word_level': 逐字对齐歌词 (JSON)
    -- 'waveform_json': 音频波形数据 (用于前端绘制波形图)

    path TEXT NOT NULL,
    
    -- 技术元数据 (ffprobe 提取)
    file_size BIGINT,           -- 字节
    duration NUMERIC(10, 2),    -- 精确时长
    codec VARCHAR(20),          -- 'h264', 'hevc', 'aac', 'flac'
    bitrate INTEGER,            -- 320000 (320kbps)
    resolution VARCHAR(20),     -- '1920x1080' (仅视频)
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);

💡 为什么要加这些字段？(Value Verification)
 * lyricist / composer (词曲作者):
   * 场景: 朋友聚会，有人说“我想唱方文山写的词”。
   * 传统系统: 搜不到。
   * 你的系统: 直接 SELECT * FROM songs WHERE lyricist LIKE '%方文山%'，瞬间显示列表。这非常专业。
 * language_dialect (方言):
   * 场景: 很多老一辈只唱“闽南语”或“粤语”老歌。
   * 区分: 不只是“Chinese”，而是明确区分 Mandarin 和 Cantonese。这对 KTV 体验至关重要。
 * singing_type (演唱形式):
   * 场景: 一男一女想合唱。
   * 功能: 筛选 singing_type = 'Duet' AND gender_type = 'Mix'。系统推荐《屋顶》、《广岛之恋》。
 * vocal_range_low/high (音域):
   * AI 价值: 你的 AI Worker (Librosa) 可以分析出这首歌的最高音是 C6。
   * 功能: 当男用户点这首歌时，系统提示：“这首歌最高音达到 High C，建议降 4 个 Key 演唱”。这是顶级 KTV 都没有的功能。
 * camelot_key (混音调式):
   * 场景: 你切歌的时候，如果上一首是 8A，下一首也是 8A 或 8B，听起来会像 DJ 混音一样顺滑，没有突兀的转调感。

